pipeline {
  agent {
    kubernetes {
      label "node-kaniko-${UUID.randomUUID().toString()}"
      defaultContainer 'node'
      yaml """
apiVersion: v1
kind: Pod
metadata:
  namespace: hypelink
spec:
  restartPolicy: Never
  containers:
    - name: node
      image: node:22.17.1-bullseye
      command: ['cat']
      tty: true
    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command: ['/busybox/sh','-c','sleep infinity']
      tty: true
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker
        - name: workspace
          mountPath: /workspace
  volumes:
    - name: workspace
      emptyDir: {}
    - name: docker-config
      secret:
        secretName: dockerhub-cred-front
        items:
          - key: .dockerconfigjson
            path: config.json
"""
    }
  }

  environment {
    IMAGE_NAME = 'raccoon98/hypelink-front-pos'
    IMAGE_TAG = "${BUILD_NUMBER}"
    DISCORD_WEBHOOK_URL = credentials('discord-webhook-front')
  }

  stages {
    stage('Checkout') {
      steps {
        container('node') {
          echo "Cloning Repository"
          checkout([$class: 'GitSCM',
            branches: [[name: '*/main']],
            userRemoteConfigs: [[url: 'https://github.com/beyond-sw-camp/be17-fin-MeshX-HypeLink-FE']]
          ])
        }
      }
    }

    stage('Node.js Build') {
      steps {
        container('node') {
          sh '''
            cd hypelinkPos
            npm ci
            npm run build
          '''
        }
      }
    }

    stage('Build & Push Docker Image with Kaniko') {
      steps {
        container('kaniko') {
          echo "Building and pushing Docker image with Kaniko"
          sh """
            /kaniko/executor \
              --context=${WORKSPACE}/hypelinkPos \
              --dockerfile=${WORKSPACE}/Dockerfile \
              --destination=${IMAGE_NAME}:${IMAGE_TAG} \
              --destination=${IMAGE_NAME}:latest \
              --single-snapshot \
              --use-new-run \
              --cache=true \
              --snapshotMode=redo
          """
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        echo "Deploying to Kubernetes with Blue-Green strategy via SSH"
        script {
          sshPublisher(
            publishers: [
              sshPublisherDesc(
                configName: 'K8S_MASTER',
                verbose: true,
                transfers: [
                  sshTransfer(
                    execCommand: """
                      if kubectl get svc hypelink-front-pos -n hypelink -o wide | grep -q "green"; then
                        CURRENT_VER="green"
                        NEXT_VER="blue"
                      else
                        CURRENT_VER="blue"
                        NEXT_VER="green"
                      fi

                      echo "Current version: \$CURRENT_VER, Next version: \$NEXT_VER"

                      cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vue-deployment-pos-\${NEXT_VER}
  namespace: hypelink
spec:
  selector:
    matchLabels:
      type: app-pos
      ver: \${NEXT_VER}
  replicas: 1
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        type: app-pos
        ver: \${NEXT_VER}
    spec:
      containers:
      - name: container
        image: ${IMAGE_NAME}:${IMAGE_TAG}
        volumeMounts:
        - name: tls-secret
          mountPath: /etc/nginx/ssl
          readOnly: true
        ports:
        - containerPort: 80
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5
          successThreshold: 2
      volumes:
      - name: tls-secret
        secret:
          secretName: hypelink-pos-tls
      terminationGracePeriodSeconds: 0
EOF

                      kubectl rollout status deployment/vue-deployment-pos-\${NEXT_VER} -n hypelink
                      kubectl patch service hypelink-front-pos -n hypelink -p '{"spec":{"selector":{"ver":"'\${NEXT_VER}'"}}}'
                      kubectl scale deployment vue-deployment-pos-\${CURRENT_VER} -n hypelink --replicas=0

                      echo "Deployment completed successfully"
                    """
                  )
                ]
              )
            ]
          )
        }
      }
    }
  }

  post {
    success {
      script {
        sh """
          curl -X POST -H 'Content-Type: application/json' \
            -d '{
              "embeds": [{
                "title": "✅ 빌드 성공: ${env.JOB_NAME}",
                "description": "이미지: ${IMAGE_NAME}:${IMAGE_TAG}\\n빌드 번호: ${env.BUILD_NUMBER}\\n하이프링크 프론트엔드 배포 성공!!!",
                "color": 65280
              }]
            }' \
            ${DISCORD_WEBHOOK_URL}
        """
      }
    }
    failure {
      script {
        sh """
          curl -X POST -H 'Content-Type: application/json' \
            -d '{
              "embeds": [{
                "title": "❌ 빌드 실패: ${env.JOB_NAME}",
                "description": "빌드 번호: ${env.BUILD_NUMBER}\\n하이프링크 프론트엔드 배포 실패 ㅠㅠ",
                "color": 16711680
              }]
            }' \
            ${DISCORD_WEBHOOK_URL}
        """
      }
    }
  }
}
