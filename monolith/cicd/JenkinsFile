pipeline {
  agent {
    kubernetes {
      label "gradle-kaniko-${UUID.randomUUID().toString()}"
      defaultContainer 'gradle'
      yaml """
apiVersion: v1
kind: Pod
metadata:
  namespace: hypelink
spec:
  restartPolicy: Never
  containers:
    - name: gradle
      image: gradle:8.9-jdk17
      command: ['cat']
      tty: true
      volumeMounts:
        - name: gradle-cache
          mountPath: /home/gradle/.gradle
        - name: workspace
          mountPath: /workspace
    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command: ['/busybox/sh','-c','sleep infinity']
      tty: true
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker
        - name: workspace
          mountPath: /workspace
  volumes:
    - name: gradle-cache
      emptyDir: {}
    - name: workspace
      emptyDir: {}
    - name: docker-config
      secret:
        secretName: dockerhub-cred
        items:
          - key: .dockerconfigjson
            path: config.json
"""
    }
  }

  environment {
    docker_name = 'raccoon98'
    GIT_URL = 'https://github.com/beyond-sw-camp/be17-fin-MeshX-HypeLink-BE'

    IMAGE_NAME = "${docker_name}/hypelink-api-monolith"
    IMAGE_TAG = "${env.BUILD_NUMBER}"

    DISCORD_WEBHOOK_URL = credentials('discord-webhook-back')
  }

  stages {

    /* -------------------------------------------------------
       1) Jenkins Git Plugin Í∏∞Î∞ò Webhook/Manual Î∏åÎûúÏπò ÌïÑÌÑ∞
    ------------------------------------------------------- */
    stage('Check Branch') {
      steps {
        script {
          def branch = env.GIT_BRANCH ?: env.BRANCH_NAME ?: ""

          echo "Detected Jenkins Branch = '${branch}'"

          // üü° ÏàòÎèô ÎπåÎìú ‚Üí env.GIT_BRANCH ÏóÜÏùå ‚Üí Î¨¥Ï°∞Í±¥ ÌÜµÍ≥º
          if (!branch?.trim()) {
            echo "‚ö†Ô∏è Manual build detected ‚Üí Skip branch filter"
            return
          }

          // üü¢ Webhook ÎπåÎìúÏùò Í≤ΩÏö∞ Swagger/MSAÎßå ÌóàÏö©
          def allow1 = "origin/Swagger/MSA"
          def allow2 = "Swagger/MSA"

          if (branch != allow1 && branch != allow2) {
            echo "‚õî Webhook blocked ‚Üí Not Swagger/MSA"
            currentBuild.result = "SUCCESS"
            error("STOP")
          }

          echo "‚úÖ Webhook from allowed branch: ${branch}"
        }
      }
    }

    /* -------------------------------------------------------
       2) Checkout
    ------------------------------------------------------- */
    stage('Checkout') {
      steps {
        container('gradle') {
          script {
            checkout([$class: 'GitSCM',
              branches: [[name: "*/Swagger/MSA"]],
              userRemoteConfigs: [[url: "${GIT_URL}"]]
            ])
          }
        }
      }
    }

    /* -------------------------------------------------------
       3) File Structure Check
    ------------------------------------------------------- */
    stage('Check File Structure') {
      steps {
        container('gradle') {
          sh '''
            echo "=== WORKSPACE ROOT ==="
            ls -la ${WORKSPACE}

            echo "=== api-monolith ==="
            ls -la ${WORKSPACE}/api-monolith || true
            ls -la ${WORKSPACE}/api-monolith/Dockerfile || true
            ls -la ${WORKSPACE}/api-monolith/build/libs || true
          '''
        }
      }
    }

    /* -------------------------------------------------------
       4) Gradle Build
    ------------------------------------------------------- */
    stage('Gradle Build (api-monolith)') {
      steps {
        container('gradle') {
          sh '''
            cd monolith
            chmod +x ../gradlew || true
            ../gradlew --no-daemon clean bootJar -x test
            ls -la build/libs
          '''
        }
      }
    }

    /* -------------------------------------------------------
       5) Kaniko Build & Push
    ------------------------------------------------------- */
    stage('Kaniko Build & Push') {
      steps {
        container('kaniko') {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            sh """
              /kaniko/executor \\
                --context=${WORKSPACE}/monolith \\
                --dockerfile=${WORKSPACE}/monolith/Dockerfile \\
                --destination=${IMAGE_NAME}:${IMAGE_TAG} \\
                --destination=${IMAGE_NAME}:latest \\
                --single-snapshot \\
                --use-new-run \\
                --cache=true \\
                --snapshotMode=redo
            """
          }
        }
      }
    }

    /* -------------------------------------------------------
       6) Kubernetes Blue/Green Î∞∞Ìè¨
    ------------------------------------------------------- */
    stage('Deploy to Kubernetes (Blue/Green for api-monolith)') {
      steps {
        echo "üöÄ Deploying api-monolith to Kubernetes (Blue/Green)"
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {

          sshPublisher(
            continueOnError: false,
            failOnError: true,
            publishers: [
              sshPublisherDesc(
                configName: 'K8S_MASTER',
                verbose: true,
                transfers: [
                  sshTransfer(
                    execCommand: """
                      IMAGE_TAG="${IMAGE_TAG}"

##############################
# ÌòÑÏû¨ Î≤ÑÏ†Ñ ÌôïÏù∏
##############################
if kubectl get service hypelink-monolith-svc -n hypelink >/dev/null 2>&1; then
  VER=\$(kubectl get service hypelink-monolith-svc -n hypelink -o jsonpath='{.spec.selector.ver}')
else
  VER=""
fi
echo "[DEBUG] Active Version = \${VER:-none}"

##############################
# ÏÉà Î≤ÑÏ†Ñ Í≤∞Ï†ï
##############################
if [ -z "\$VER" ]; then
  NEW_VER="blue"
elif [ "\$VER" = "blue" ]; then
  NEW_VER="green"
else
  NEW_VER="blue"
fi
echo "[DEBUG] New Version = \$NEW_VER"

##############################
# ÏÉàÎ°úÏö¥ Deployment Ï†ÅÏö©
##############################
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: spring-monolith-deployment-\$NEW_VER
  namespace: hypelink
spec:
  replicas: 1
  selector:
    matchLabels:
      type: monolith
      ver: \$NEW_VER
  template:
    metadata:
      labels:
        type: monolith
        ver: \$NEW_VER
    spec:
      containers:
        - name: container
          image: ${docker_name}/hypelink-api-monolith:\$IMAGE_TAG
          ports:
            - containerPort: 8080
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
          envFrom:
            - configMapRef:
                name: hypelink-monolith-config
          livenessProbe:
            httpGet:
              path: /api/health/health
              port: 8080
          readinessProbe:
            httpGet:
              path: /api/health/test
              port: 8080
          startupProbe:
            httpGet:
              path: /api/health/health
              port: 8080
EOF

kubectl rollout status deployment/spring-monolith-deployment-\$NEW_VER -n hypelink --timeout=600s

##############################
# ÏÑúÎπÑÏä§ Blue/Green Ï†ÑÌôò
##############################
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: hypelink-monolith-svc
  namespace: hypelink
spec:
  selector:
    type: monolith
    ver: \$NEW_VER
  ports:
    - port: 8080
      targetPort: 8080
EOF

##############################
# Ïù¥Ï†Ñ Î≤ÑÏ†Ñ Scale Down
##############################
if [ -n "\$VER" ]; then
  kubectl scale deployment/spring-monolith-deployment-\$VER -n hypelink --replicas=0
fi

                    """
                  )
                ]
              )
            ]
          )
        }
      }
    }

    stage('Result') {
      steps {
        echo "‚úî api-monolith Î∞∞Ìè¨ ÏôÑÎ£å: ${IMAGE_NAME}:${IMAGE_TAG}"
      }
    }
  }

  /* -------------------------------------------------------
       Discord Notification
  ------------------------------------------------------- */
  post {
    success {
      script {
        sh """
          curl -X POST -H 'Content-Type: application/json' \
            -d '{"embeds":[{"title":"api-monolith Î∞∞Ìè¨ ÏÑ±Í≥µ","description":"${IMAGE_NAME}:${IMAGE_TAG}","color":65280}]}' \
            ${DISCORD_WEBHOOK_URL}
        """
      }
    }
    failure {
      script {
        sh """
          curl -X POST -H 'Content-Type: application/json' \
            -d '{"embeds":[{"title":"api-monolith Î∞∞Ìè¨ Ïã§Ìå®","description":"ÎπåÎìú Î≤àÌò∏: ${env.BUILD_NUMBER}","color":16711680}]}' \
            ${DISCORD_WEBHOOK_URL}
        """
      }
    }
  }
}
